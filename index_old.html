<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>SMR • WebGL</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />

    <style>
        :root {
            --bg: #0b0f14;
            --panel: #111621;
            --muted: #6b7280;
            --text: #e5e7eb;
            --accent: #3b82f6;
            --card: #0f1522;
            --ok: #10b981;
            --warn: #f59e0b;
            --err: #ef4444;
            --br: 12px;
        }

        html, body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font: 14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif
        }

        #root {
            display: grid;
            grid-template-columns: 1fr 540px;
            gap: 16px;
            height: 100vh;
            padding: 16px;
            box-sizing: border-box
        }

        #unity-container {
            position: relative;
            border-radius: var(--br);
            overflow: hidden;
            background: #000;
            box-shadow: 0 6px 24px rgba(0,0,0,.35)
        }

        #unity-footer {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg,transparent,rgba(0,0,0,.6));
            padding: 6px 8px;
            display: flex;
            align-items: center;
            gap: 8px
        }

        #unity-build-title {
            margin-left: auto;
            font-weight: 600;
            color: #cbd5e1
        }

        #side {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }

        .card {
            background: var(--panel);
            border-radius: var(--br);
            padding: 14px;
            box-shadow: 0 6px 24px rgba(0,0,0,.25)
        }

            .card h3 {
                margin: 0 0 10px;
                font-size: 14px;
                color: #cbd5e1;
                letter-spacing: .3px
            }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px
        }

        .row {
            display: grid;
            gap: 6px
        }

        label {
            font-size: 12px;
            color: var(--muted)
        }

        input[type="number"] {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #1f2937;
            background: #0e1421;
            color: var(--text);
            outline: none
        }

            input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button {
                opacity: 1
            }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 12px;
            cursor: pointer;
            font-weight: 600
        }

            .btn.secondary {
                background: #1f2937
            }

            .btn:active {
                transform: translateY(1px)
            }

        .actions {
            display: flex;
            gap: 8px;
            margin-top: 8px
        }

        .console {
            height: auto;
            flex: 1;
            min-height: 0;
            overflow: auto;
            background: #0a0f19;
            border: 1px solid #1f2937;
            border-radius: 10px;
            padding: 10px;
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        }
        /* La carte "Console" occupe tout l’espace vertical restant */
        #console-card {
            display: flex;
            flex-direction: column;
            flex: 1; /* prend le reste de la hauteur dans #side */
            min-height: 0; /* permet à .console de scroller */
        }

        .log {
            white-space: pre-wrap;
            margin: 0
        }

            .log.warn {
                color: var(--warn)
            }

            .log.err {
                color: var(--err)
            }

            .log.ok {
                color: var(--ok)
            }

        .muted {
            color: var(--muted)
        }

        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 8px
        }

        .pill {
            padding: 4px 8px;
            border-radius: 999px;
            background: #0e1421;
            border: 1px solid #1f2937;
            font-size: 12px
        }

        .kv {
            display: flex;
            gap: 6px;
            align-items: center
        }

            .kv b {
                font-weight: 600;
                color: #cbd5e1
            }

        @media (max-width: 1100px) {
            #root {
                grid-template-columns: 1fr
            }

            #side {
                order: -1
            }
        }

        #unity-container {
            width: 100%;
            height: 100%;
            display: flex;
        }

        #unity-canvas {
            width: 100%; /* Prend toute la largeur dispo dans la colonne gauche */
            height: auto;
            aspect-ratio: 16 / 9; /* Garde le ratio */
            max-height: 100%; /* Ne dépasse pas la hauteur dispo */
            background: #000;
            display: block;
        }

        .grid {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .row {
            display: grid;
            grid-template-columns: 120px 1fr; /* largeur fixe pour label + input qui prend le reste */
            align-items: center;
            gap: 8px;
        }

            .row label {
                font-size: 14px;
                font-weight: 500;
            }

            .row input {
                width: 100%;
                padding: 6px 8px;
                box-sizing: border-box;
                font-size: 14px;
            }

                /* optionnel : masquer les flèches ↑↓ sur les number */
                .row input[type="number"]::-webkit-outer-spin-button,
                .row input[type="number"]::-webkit-inner-spin-button {
                    -webkit-appearance: none;
                    margin: 0;
                }

                .row input[type="number"] {
                    -moz-appearance: textfield; /* Firefox */
                }
    </style>
</head>
<body>
    <div id="root">
        <!-- Unity canvas -->
        <div id="unity-container" class="unity-desktop">
            <canvas id="unity-canvas" tabindex="-1"></canvas>
            <div id="unity-loading-bar">
                <div id="unity-logo"></div>
                <div id="unity-progress-bar-empty">
                    <div id="unity-progress-bar-full"></div>
                </div>
            </div>
            <div id="unity-warning"></div>
            <div id="unity-footer">
                <div id="unity-logo-title-footer"></div>
                <div id="unity-fullscreen-button"></div>
                <div id="unity-build-title">SMR</div>
            </div>
        </div>

        <!-- Side panel -->
        <aside id="side">
            <div class="card">
                <div class="toolbar">
                    <h3>Importer un modèle</h3>
                    <span class="pill" id="fps">FPS: …</span>
                </div>

                <div class="grid">
                    <div class="row">
                        <label for="typeId">Type ID</label>
                        <input id="typeId" type="number" value="1" inputmode="numeric" pattern="[0-9]*" />
                    </div>
                    <div class="row">
                        <label for="familyId">Family ID</label>
                        <input id="familyId" type="number" value="1" inputmode="numeric" pattern="[0-9]*" />
                    </div>
                    <div class="row">
                        <label for="aircraftId">Aircraft ID</label>
                        <input id="aircraftId" type="number" value="1" inputmode="numeric" pattern="[0-9]*" />
                    </div>
                    <div class="row">
                        <label for="liveryId">Livery ID</label>
                        <input id="liveryId" type="number" value="1" inputmode="numeric" pattern="[0-9]*" />
                    </div>
                </div>

                <div class="actions">
                    <button id="importBtn" class="btn">Importer</button>
                    <button id="clearBtn" class="btn secondary">Clear</button>
                </div>
                <div class="muted" style="margin-top:6px">
                    <div class="kv"><b>GO cible:</b> <span id="goNameLabel">Engine</span></div>
                    <div class="kv"><b>Méthode:</b> ImportFromJson(string)</div>
                </div>
            </div>

            <div class="card" id="console-card">
                <h3>Console</h3>
                <div class="console" id="console"></div>
            </div>
        </aside>
    </div>

    <script>
        // ─────────────────────────────────────────────────────────────────────────────
        // Config Unity (garde ton template Unity si besoin, ici minimal)
        // ─────────────────────────────────────────────────────────────────────────────
        const canvas = document.querySelector("#unity-canvas");

        function unityShowBanner(msg, type) {
            const warningBanner = document.querySelector("#unity-warning");
            const div = document.createElement('div');
            div.innerHTML = msg;
            div.style = 'padding:10px;' + (type === 'error' ? 'background:red;' : 'background:yellow;');
            warningBanner.appendChild(div);
            setTimeout(() => { warningBanner.removeChild(div); warningBanner.style.display = warningBanner.children.length ? 'block' : 'none'; }, 5000);
            warningBanner.style.display = 'block';
        }

        const buildUrl = ""; // "Build/";
        const loaderUrl = buildUrl + "SMR.loader.js";
        const config = {
            arguments: [],
            dataUrl: buildUrl + "SMR.data",
            frameworkUrl: buildUrl + "SMR.framework.js",
            codeUrl: buildUrl + "SMR.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "VRDTMStudio",
            productName: "SMR",
            productVersion: "0.1.0",
            showBanner: unityShowBanner,
            // devicePixelRatio: 1, // uncomment pour booster perfs
            locateFile: (path) => {
                // replace 'build' by 'SMR' into path
                var newPath = buildUrl + path.replace("build", "SMR");
                console.log(path + " => " + newPath)
                return buildUrl + newPath;
            }
        };

        // ─────────────────────────────────────────────────────────────────────────────
        // UI + Logs
        // ─────────────────────────────────────────────────────────────────────────────
        const GAMEOBJECT_NAME = "Engine"; // ← adapte si nécessaire
        document.getElementById('goNameLabel').textContent = GAMEOBJECT_NAME;

        const $console = document.getElementById('console');
        function appendLog(text, cls = '') {
            const p = document.createElement('div');
            p.className = `log ${cls}`;
            p.textContent = text;
            $console.appendChild(p);
            $console.scrollTop = $console.scrollHeight;
        }
        // Miroir de la console navigateur
        (function hookConsole() {
            const _log = console.log, _warn = console.warn, _err = console.error;
            console.log = (...a) => { _log(...a); appendLog(a.join(' '), 'ok'); };
            console.warn = (...a) => { _warn(...a); appendLog(a.join(' '), 'warn'); };
            console.error = (...a) => { _err(...a); appendLog(a.join(' '), 'err'); };
        })();

        // FPS simple
        (function fpsCounter() {
            const fpsEl = document.getElementById('fps');
            let last = performance.now(), frames = 0, acc = 0;
            function tick() {
                const now = performance.now(), dt = now - last; last = now; frames++; acc += dt;
                if (acc >= 500) { fpsEl.textContent = 'FPS: ' + Math.round(frames * 1000 / acc); frames = 0; acc = 0; }
                requestAnimationFrame(tick);
            }
            requestAnimationFrame(tick);
        })();

        // ─────────────────────────────────────────────────────────────────────────────
        // Loader Unity
        // ─────────────────────────────────────────────────────────────────────────────
        let unityInstance = null;

        document.querySelector("#unity-loading-bar").style.display = "block";
        const script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
                document.querySelector("#unity-progress-bar-full").style.width = (100 * progress) + "%";
            }).then((instance) => {
                unityInstance = instance;

                // Propager les logs Unity vers notre console
                try {
                    const mod = unityInstance.Module || {};
                    const prevPrint = mod.print, prevPrintErr = mod.printErr;
                    mod.print = (t) => { appendLog(String(t), 'ok'); if (prevPrint) prevPrint(t); };
                    mod.printErr = (t) => { appendLog(String(t), 'err'); if (prevPrintErr) prevPrintErr(t); };
                } catch (e) { console.warn('Module print hook failed', e); }

                // Fullscreen
                document.querySelector("#unity-loading-bar").style.display = "none";
                document.querySelector("#unity-fullscreen-button").onclick = () => unityInstance.SetFullscreen(1);

                document.querySelectorAll("input, textarea").forEach(el => {
                    el.addEventListener("focus", () => {
                        if (unityInstance && unityInstance.Module) {
                            unityInstance.Module.canvas.focus = () => { }; // Désactive la prise de focus par Unity
                        }
                    });

                    el.addEventListener("blur", () => {
                        if (unityInstance && unityInstance.Module) {
                            unityInstance.Module.canvas.focus = unityInstance.Module["canvas"].__proto__.focus;
                        }
                    });
                });

                (function stopUnityKeyCaptureWhenTyping() {
                    const isTyping = () => {
                        const a = document.activeElement;
                        if (!a) return false;
                        const tag = a.tagName.toLowerCase();
                        return tag === 'input' || tag === 'textarea' || a.isContentEditable;
                    };

                    // Capture phase (3e argument = true) pour bloquer avant que Unity ne reçoive l’event
                    window.addEventListener('keydown', e => { if (isTyping()) e.stopPropagation(); }, true);
                    window.addEventListener('keypress', e => { if (isTyping()) e.stopPropagation(); }, true);
                    window.addEventListener('keyup', e => { if (isTyping()) e.stopPropagation(); }, true);
                })();

                appendLog('Unity prêt ✔️', 'ok');

            }).catch((message) => {
                appendLog('Unity error: ' + message, 'err');
                alert(message);
            });
        };
        document.body.appendChild(script);

        // ─────────────────────────────────────────────────────────────────────────────
        // Actions UI → Unity
        // ─────────────────────────────────────────────────────────────────────────────
        function sendImport() {
            if (!unityInstance) { appendLog('Unity pas prêt', 'warn'); return; }
            const data = {
                TypeId: parseInt(document.getElementById("typeId").value || '0', 10),
                FamilyId: parseInt(document.getElementById("familyId").value || '0', 10),
                AircraftId: parseInt(document.getElementById("aircraftId").value || '0', 10),
                LiveryId: parseInt(document.getElementById("liveryId").value || '0', 10),
            };
            const json = JSON.stringify(data);
            try {
                unityInstance.SendMessage(GAMEOBJECT_NAME, "ImportFromJson", json);
                appendLog('SendMessage ImportFromJson: ' + json, 'ok');
            } catch (e) {
                appendLog('SendMessage error: ' + e.message, 'err');
            }
        }

        document.getElementById('importBtn').addEventListener('click', sendImport);
        document.getElementById('clearBtn').addEventListener('click', () => { $console.innerHTML = ''; });

        // Bonus: Enter pour déclencher l’import
        ['typeId', 'familyId', 'aircraftId', 'liveryId'].forEach(id => {
            document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); sendImport(); } });
        });

        // Responsive sizing (optionnel)
        (function fitCanvas() {
            function fit() {
                // 16/9 par défaut
                const w = Math.min(window.innerWidth - 400, 1600);
                const h = Math.round(w * 9 / 16);
                canvas.style.width = w + 'px';
                canvas.style.height = h + 'px';
            }
            window.addEventListener('resize', fit); fit();
        })();
    </script>
</body>
</html>
